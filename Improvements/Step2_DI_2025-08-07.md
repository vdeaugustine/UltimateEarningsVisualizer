# Step 2 â€” Dependency Injection & Repository Setup (2025-08-07)

This step establishes a lightweight DI layer and begins extracting data access into repositories to decouple view models from singletons and prepare for testing.

## Changes in this step

- **AppDependencies container**
  - File: `UltimateMoneyVisualizer/AppDependencies/AppDependencies.swift`
  - Provides: `UserProviding`, `NavigationCoordinating`, and `EarningsRepository`
  - Default impls: `DefaultUserProvider`, `NavCoordinator`, `DefaultEarningsRepository`

- **SwiftUI Environment key for dependencies**
  - File: `UltimateMoneyVisualizer/AppDependencies/Environment+Dependencies.swift`
  - Injected in app entry: `UltimateMoneyVisualizer/--TopLevel/UltimateMoneyVisualizerApp.swift`

- **ViewModels updated to consume DI**
  - File: `UltimateMoneyVisualizer/NewHomeView/View Model/NewHomeViewModel.swift`
    - Uses injected `user` and `navigator`
    - Fix: `taxesToggleOn` now initialized after `user` to avoid init order issues
  - File: `UltimateMoneyVisualizer/Stats/StatsViewModel.swift`
    - Uses injected `user`, `navigator`, and `earningsRepository`
    - Fetches data via repository instead of `User.main`

- **Repository introduced**
  - File: `UltimateMoneyVisualizer/Data/Repositories/EarningsRepository.swift`
  - Protocol + default implementation proxy to `User` for now

## Why this matters

- **Decoupling**: ViewModels no longer hard-depend on singletons, enabling easier testing and future refactors.
- **Testability**: Repositories can be mocked to drive ViewModels in unit tests.
- **Migration path**: Data logic can gradually move out of ViewModels into services without large rewrites.

## Follow-ups (short-term)

- [ ] Migrate additional ViewModels to use repositories where they read model collections
- [ ] Extract derived computations (totals, breakdowns) into service/repository layers
- [ ] Add a basic test harness (in-memory Core Data) and a few unit tests for `StatsViewModel.refresh()`
- [ ] Add a simple `README` section for DI & repositories

## Verification checklist

- [ ] App builds and runs
- [ ] Home and Stats screens navigate and display as before
- [ ] No forced crashes from persistence (from Step 1)
- [ ] Console shows emoji logs for notifications (from Step 1)
